name: CI/CD MLflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CONDA_ENV_NAME: mlflow-env
  CONDA_ENV_PATH: MLproject/conda.yaml
  DOCKER_IMAGE_NAME: mpg 

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Kode
      - name: Checks out repository
        uses: actions/checkout@v4

      # 2. Setup Conda dan Install Dependencies
      - name: Set up Conda & Install Dependencies
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: '3.12.7' 
          activate-environment: ${{ env.CONDA_ENV_NAME }} 
          environment-file: ${{ env.CONDA_ENV_PATH }}
          auto-activate-base: false

      # 3. Run MLflow Project
      - name: Run MLflow Project
        run: |
          conda run -n ${{ env.CONDA_ENV_NAME }} mlflow run MLproject

      # 4. Get Latest MLflow run_id
      - name: Get latest MLflow run_id
        id: get_run_id
        run: |
          RUN_ID=$(ls -td mlruns/0/*/ | head -n 1 | cut -d'/' -f3)

          if [ -z "$RUN_ID" ]; then
            echo "FATAL ERROR: RUN_ID tidak ditemukan."
            exit 1
          fi

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run_id: $RUN_ID"

      # 5. Build Docker Model
      - name: Build Docker Model
        run: |
          conda run -n ${{ env.CONDA_ENV_NAME }} mlflow models build-docker \
            --model-uri "runs:/$RUN_ID/model" \
            --name ${{ env.DOCKER_IMAGE_NAME }}

      # 6. Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 7. Tag Docker Image
      - name: Tag Docker Image
        run: |
          docker tag ${{ env.DOCKER_IMAGE_NAME }} ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # 8. Push Docker Image
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      # Commit & Push Artifact ke Repository
      - name: Push MLflow Artifacts to Repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add mlruns/

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Add MLflow artifacts for run $RUN_ID"
          git push
